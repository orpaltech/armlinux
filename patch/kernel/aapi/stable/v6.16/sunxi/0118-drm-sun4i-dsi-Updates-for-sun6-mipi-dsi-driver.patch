From a09fd1ad3fa1fe271e4990aa69521c63e775f0ae Mon Sep 17 00:00:00 2001
From: Sergey Suloev <sergey.suloev@gmail.com>
Date: Thu, 3 Jul 2025 14:43:54 +0300
Subject: [PATCH] drm/sun4i: dsi: Updates for sun6-mipi-dsi driver

---
 drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c | 26 ++++++++++++++++++++++----
 1 file changed, 22 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c b/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c
index c35b70d..264831c 100644
--- a/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c
+++ b/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c
@@ -6,6 +6,8 @@
  * Maxime Ripard <maxime.ripard@bootlin.com>
  */
 
+#define DEBUG
+
 #include <linux/clk.h>
 #include <linux/component.h>
 #include <linux/crc-ccitt.h>
@@ -21,6 +23,7 @@
 
 #include <drm/drm_atomic_helper.h>
 #include <drm/drm_mipi_dsi.h>
+#include <drm/drm_of.h>
 #include <drm/drm_panel.h>
 #include <drm/drm_print.h>
 #include <drm/drm_probe_helper.h>
@@ -720,6 +723,7 @@ static void sun6i_dsi_encoder_enable(struct drm_encoder *encoder)
 	struct mipi_dsi_device *device = dsi->device;
 	union phy_configure_opts opts = { };
 	struct phy_configure_opts_mipi_dphy *cfg = &opts.mipi_dphy;
+	u32 eotp_enable = 0;
 	u16 delay;
 	int err;
 
@@ -737,8 +741,12 @@ static void sun6i_dsi_encoder_enable(struct drm_encoder *encoder)
 	 */
 	regmap_write(dsi->regs, SUN6I_DSI_CTL_REG, SUN6I_DSI_CTL_EN);
 
+	if (!(device->mode_flags & MIPI_DSI_MODE_NO_EOT_PACKET))
+		eotp_enable |= SUN6I_DSI_BASIC_CTL0_HS_EOTP_EN;
 	regmap_write(dsi->regs, SUN6I_DSI_BASIC_CTL0_REG,
-		     SUN6I_DSI_BASIC_CTL0_ECC_EN | SUN6I_DSI_BASIC_CTL0_CRC_EN);
+		     eotp_enable |
+		     SUN6I_DSI_BASIC_CTL0_ECC_EN |
+		     SUN6I_DSI_BASIC_CTL0_CRC_EN);
 
 	regmap_write(dsi->regs, SUN6I_DSI_TRANS_START_REG, 10);
 	regmap_write(dsi->regs, SUN6I_DSI_TRANS_ZERO_REG, 0);
@@ -1052,8 +1060,11 @@ static int sun6i_dsi_bind(struct device *dev, struct device *master,
 {
 	struct drm_device *drm = data;
 	struct sun6i_dsi *dsi = dev_get_drvdata(dev);
+	struct drm_connector *connector = &dsi->connector;
 	int ret;
 
+	dev_dbg(dsi->dev, "is drm registered? %d\n", drm->registered);
+
 	drm_encoder_helper_add(&dsi->encoder,
 			       &sun6i_dsi_enc_helper_funcs);
 	ret = drm_simple_encoder_init(drm, &dsi->encoder,
@@ -1064,9 +1075,9 @@ static int sun6i_dsi_bind(struct device *dev, struct device *master,
 	}
 	dsi->encoder.possible_crtcs = BIT(0);
 
-	drm_connector_helper_add(&dsi->connector,
+	drm_connector_helper_add(connector,
 				 &sun6i_dsi_connector_helper_funcs);
-	ret = drm_connector_init(drm, &dsi->connector,
+	ret = drm_connector_init(drm, connector,
 				 &sun6i_dsi_connector_funcs,
 				 DRM_MODE_CONNECTOR_DSI);
 	if (ret) {
@@ -1075,7 +1086,14 @@ static int sun6i_dsi_bind(struct device *dev, struct device *master,
 		goto err_cleanup_connector;
 	}
 
-	drm_connector_attach_encoder(&dsi->connector, &dsi->encoder);
+	dev_dbg(dsi->dev, "Set connector panel orientation\n");
+	ret = drm_connector_set_panel_orientation(connector,
+					DRM_MODE_PANEL_ORIENTATION_RIGHT_UP);
+	if (ret)
+		dev_warn(dsi->dev,
+			"Unable to set panel orientation: %d\n", ret);
+
+	drm_connector_attach_encoder(connector, &dsi->encoder);
 
 	dsi->drm = drm;
 
-- 
2.43.0

