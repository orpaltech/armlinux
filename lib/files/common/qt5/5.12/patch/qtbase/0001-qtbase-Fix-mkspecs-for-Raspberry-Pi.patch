From 6ea551ac9a17c9bd0412ce968eb1661150f45fbf Mon Sep 17 00:00:00 2001
From: Sergey Suloev <ssuloev@orpaltech.com>
Date: Fri, 21 Dec 2018 23:03:53 +0300
Subject: [PATCH] qtbase: Fix mkspecs for Raspberry-Pi

---
 mkspecs/devices/linux-rasp-pi3-g++/qmake.conf |  6 ++--
 .../devices/linux-rasp-pi3-vc4-g++/qmake.conf | 28 +++++++++++++++----
 2 files changed, 25 insertions(+), 9 deletions(-)

diff --git a/mkspecs/devices/linux-rasp-pi3-g++/qmake.conf b/mkspecs/devices/linux-rasp-pi3-g++/qmake.conf
index 2bb70ff..8328746 100644
--- a/mkspecs/devices/linux-rasp-pi3-g++/qmake.conf
+++ b/mkspecs/devices/linux-rasp-pi3-g++/qmake.conf
@@ -13,7 +13,7 @@ QMAKE_RPATHLINKDIR_POST += $$[QT_SYSROOT]/opt/vc/lib
 VC_LIBRARY_PATH         = /opt/vc/lib
 VC_INCLUDE_PATH         = =/opt/vc/include
 
-VC_LINK_LINE            = -L=$${VC_LIBRARY_PATH}
+VC_LINK_LINE            = -L=$${VC_LIBRARY_PATH} -Wl,-rpath,$${VC_LIBRARY_PATH}
 
 QMAKE_LIBDIR_OPENGL_ES2 = =$${VC_LIBRARY_PATH}
 QMAKE_LIBDIR_EGL        = $$QMAKE_LIBDIR_OPENGL_ES2
@@ -31,13 +31,13 @@ QMAKE_LIBS_OPENGL_ES2   = $${VC_LINK_LINE} -lGLESv2
 # The official opt vc EGL references GLESv2 symbols: need to link it
 QMAKE_LIBS_EGL          = $${VC_LINK_LINE} -lEGL -lGLESv2
 
-QMAKE_CFLAGS            = -march=armv8-a -mtune=cortex-a53 -mfpu=crypto-neon-fp-armv8
+QMAKE_CFLAGS            = -march=armv7-a -marm -mthumb-interwork -mfpu=vfpv4 -mtune=cortex-a53
 QMAKE_CXXFLAGS          = $$QMAKE_CFLAGS
 
 DISTRO_OPTS            += hard-float
 DISTRO_OPTS            += deb-multi-arch
 
-EGLFS_DEVICE_INTEGRATION= eglfs_brcm
+EGLFS_DEVICE_INTEGRATION = eglfs_brcm
 
 include(../common/linux_arm_device_post.conf)
 
diff --git a/mkspecs/devices/linux-rasp-pi3-vc4-g++/qmake.conf b/mkspecs/devices/linux-rasp-pi3-vc4-g++/qmake.conf
index 75b6ad7..ccefd1d 100644
--- a/mkspecs/devices/linux-rasp-pi3-vc4-g++/qmake.conf
+++ b/mkspecs/devices/linux-rasp-pi3-vc4-g++/qmake.conf
@@ -28,14 +28,30 @@
 
 include(../common/linux_device_pre.conf)
 
-QMAKE_LIBS_EGL         += -lEGL
-QMAKE_LIBS_OPENGL_ES2  += -lGLESv2 -lEGL
+QT_QPA_DEFAULT_PLATFORM	= eglfs
 
-QMAKE_CFLAGS            = -march=armv8-a -mtune=cortex-a53 -mfpu=crypto-neon-fp-armv8
-QMAKE_CXXFLAGS          = $$QMAKE_CFLAGS
+QMAKE_INCDIR_POST	+= \
+	$$[QT_SYSROOT]/usr/include
 
-DISTRO_OPTS            += hard-float
-DISTRO_OPTS            += deb-multi-arch
+QMAKE_LIBDIR_POST	+= \
+	$$[QT_SYSROOT]/usr/lib \
+	$$[QT_SYSROOT]/usr/lib/arm-linux-gnueabihf \
+	$$[QT_SYSROOT]/lib/arm-linux-gnueabihf
+
+QMAKE_RPATHLINKDIR_POST	+= \
+	$$[QT_SYSROOT]/usr/lib \
+	$$[QT_SYSROOT]/usr/lib/arm-linux-gnueabihf \
+	$$[QT_SYSROOT]/lib/arm-linux-gnueabihf
+
+
+QMAKE_LIBS_EGL		+= -lEGL
+QMAKE_LIBS_OPENGL_ES2	+= -lGLESv2
+
+QMAKE_LIBS		+= -lrt -lpthread -ldl -lz
+COMPILER_FLAGS		+= -march=armv7-a -marm -mthumb-interwork -mfpu=vfpv4 -mtune=cortex-a53
+
+DISTRO_OPTS		+= hard-float
+DISTRO_OPTS		+= deb-multi-arch
 
 EGLFS_DEVICE_INTEGRATION = eglfs_kms
 
-- 
2.17.1

